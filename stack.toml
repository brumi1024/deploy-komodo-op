[[server]]
name = "Local"
[server.config]
address = "https://host.docker.internal:8120"
enabled = true

##

[[server]]
name = "home-server"
[server.config]
address = "https://host.docker.internal:8120"
enabled = true

##

[[server]]
name = "sequoia-server"
[server.config]
address = "https://docker-test2.van-tetra.ts.net:8120"
enabled = true
passkey = "I2bH3K73gwsSIDdUVm5c3CU1flz9nAMF"

##

[[stack]]
name = "komodo-op"
tags = [
  "infrastructure",
  "1password-connect"
]
[stack.config]
server = "home-server"
poll_for_updates = true
auto_update = true
destroy_before_deploy = true
git_account = "brumi1024"
repo = "brumi1024/deploy-komodo-op"
reclone = true
file_paths = [
  "docker-compose.yaml",
  "compose.override.yaml"
]
environment = """
KOMODO_HOST=http://host.docker.internal:9120
KOMODO_API_KEY=[[KOMODO_API_KEY]]
KOMODO_API_SECRET=[[KOMODO_API_SECRET]]
OP_SERVICE_ACCOUNT_TOKEN=[[OP_SERVICE_ACCOUNT_TOKEN]]
OP_CREDENTIALS_BASE64=[[OP_CREDENTIALS_BASE64]]
OP_VAULT=[[OP_VAULT_UUID]]
SYNC_INTERVAL=30s
LOG_LEVEL=INFO
"""

##

[[procedure]]
name = "Backup Core Database"
description = "Triggers the Core database backup at the scheduled time."
tags = ["system"]
config.schedule = "Every day at 01:00"

[[procedure.config.stage]]
name = "Stage 1"
enabled = true
executions = [
  { execution.type = "BackupCoreDatabase", execution.params = {}, enabled = true }
]

##

[[procedure]]
name = "Global Auto Update"
description = "Pulls and auto updates Stacks and Deployments using 'poll_for_updates' or 'auto_update'."
tags = ["system"]
config.schedule = "Every day at 03:00"

[[procedure.config.stage]]
name = "Stage 1"
enabled = true
executions = [
  { execution.type = "GlobalAutoUpdate", execution.params = {}, enabled = true }
]

##

[[builder]]
name = "Local"
[builder.config]
type = "Server"
params.server_id = "Local"

##

[[resource_sync]]
name = "komodo-op-sync"
tags = [
  "infrastructure",
  "1password-connect",
  "sync"
]
[resource_sync.config]
repo = "brumi1024/deploy-komodo-op"
git_account = "brumi1024"
resource_path = ["stack.toml"]
managed = true